# 代理记账业务管理系统

本系统专为中小代理记账公司开发，致力于帮助企业高效管理客户、合同、服务期、分段、周期性和临时收费，并提供到期提醒、催收提醒等功能。系统基于 **PHP + SQLite3**，无需部署数据库服务器，开箱即用！

---

## 更新日志

- **v1.1**  
  增加权限控制，必须登录后才能访问相关模块。
- **v1.2**  
  新增客户唯一性验证、批量导入客户、工商年报登记与多用户管理功能。
- **v1.3**  
  新增“纳税所属期”登记，支持电子税务局/个税客户端申报状态记录，修正周期/申报逻辑，细化页面权限。
- **v1.4**  
  新增一键“导出全部数据”功能，支持以CSV表格格式导出所有业务数据，可用Excel直接打开分析。
- **v1.5**  
  新增合同电子签署与模板管理功能。支持在线签署合同（含签名图片）、合同模板变量自动替换，支持盖章/签名图片插入。合同管理、客户管理实现解耦。
- **v1.6**
  优化移动版支持。
- **v1.7**
  增加合同签署的UUID；JS和CSS本地化处理。
- **v1.7.1**
  增加合同快照。
  
---

- **V1.8**
  1.8版本完全不同于之前的版本，增加了**合同签署流程（含短信验证码、合同编号、哈希、查验二维码、数据存证、低成本防伪）**，需要在云片网注册账号、实名认证、获取APIKEY并且需要报备短信前面和模板。使用难度和成本增加，故单独分支，单独维护。
  需要修改`send_sms.php`文件中的`yunpian_apikey`和`你的签名`这两个参数。

---

## 功能简介

- **客户管理**：客户信息增删改查、唯一性校验、批量导入。
- **合同管理**：合同台账、合同模板、在线签署、签署链接生成与复制、签名图片自动插入、合同编号与签署时间管理。
- **服务期管理**：支持客户多服务期、服务分段，适合价格变更、补差、续费等场景。
- **分段管理**：每个服务期可灵活拆分多个分段，分段可设置独立年费、套餐、备注。
- **收费管理**：周期性收费与临时收费分开管理，自动统计已收/待收金额，防止超额收款。
- **临时收费**：支持录入预付款、杂费等临时收款，关联客户并可在客户详情中查看。
- **到期提醒**：提前预警服务期即将到期客户，支持自定义提醒天数。
- **催收提醒**：自动筛查所有“未收全款”的服务期，便于及时催收。
- **权限与多用户控制**：必须登录后才能访问，支持多用户管理，默认账号 admin，密码 123456。
- **数据导出**：可一键导出全部业务数据为CSV表格，便于分析和归档。
- **数据安全**：所有数据本地化存储，无需外部依赖，便于备份。

---

## 快速部署

1. **环境要求**
   - PHP 7.4+（建议 8.x），需启用 SQLite3 扩展
   - 支持常见 Web 服务器（Apache/Nginx/IIS/自带 PHP 内置服务器等）

2. **部署步骤**
   - 将所有 PHP 文件与 `db.php` 放在同一目录。
   - 目录需有写权限，首次访问会自动创建 `accounting.db` 数据库文件。
   - 直接访问 `index.php` 即可使用。

3. **数据库说明**
   - 数据库存储于 `accounting.db`，主要数据表包括：`contracts`、`contracts_agreement`、`contract_templates`、`service_periods`、`service_segments`、`payments`、`users`。
   - 可用 SQLite 工具备份/导出/分析数据。

---

## 目录结构

```
/index.php                    # 客户列表页
/contract_add.php             # 新增客户
/contract_edit.php            # 编辑客户
/contract_delete.php          # 删除客户
/contract_detail.php          # 客户详情/服务期/临时收费
/service_period_add.php       # 新增/续费服务期
/service_period_delete.php    # 删除服务期
/segment_add.php              # 服务期分段调整
/payment_list.php             # 周期性收费记录
/payment_add.php              # 新增周期性收费
/payment_delete.php           # 删除周期性收费
/temp_payment.php             # 临时收费录入与管理
/expire_remind.php            # 到期提醒
/remind_list.php              # 催收提醒
/user_manage.php                    # 用户管理
/export_all_data.php          # 一键导出所有业务数据为CSV
/ht_agreements.php            # 合同管理
/ht_agreement_add.php         # 新建合同
/ht_agreement_detail.php      # 合同详情
/ht_agreement_sign.php        # 在线签署合同
/ht_agreement_delete.php      # 删除合同
/ht_contract_templates.php    # 合同模板管理
/ht_contract_template_edit.php# 编辑/新建合同模板
/db.php                       # 数据库及表结构初始化
/navbar.php                   # 通用导航栏
/accounting.db                # SQLite数据库（自动生成）
```

---

## 合同模板变量说明

合同模板支持以下变量，生成合同时会自动替换为实际内容：

| 变量名                | 说明                 |
|-----------------------|----------------------|
| `{client_name}`       | 客户名称             |
| `{contact_person}`    | 客户联系人           |
| `{contact_phone}`     | 客户电话             |
| `{contact_email}`     | 客户邮箱             |
| `{remark}`            | 客户备注             |
| `{service_start}`     | 服务期开始日期       |
| `{service_end}`       | 服务期结束日期       |
| `{month_count}`       | 服务月数             |
| `{package_type}`      | 套餐类型             |
| `{price_per_year}`    | 每年价格/分段价格    |
| `{segment_fee}`       | 分段费用（如使用分段）|
| `{seal}`              | 甲方盖章（签章图片） |
| `{signature}`         | 甲方签名图片         |
| `{sign_date}`         | 合同签署时间         |

> 注：如需支持更多变量，可在合同模板管理页面和后台逻辑中扩展。

---

## 数据模型与业务逻辑

### 1. 主体数据表

- `contracts` 客户/合同表
- `contracts_agreement` 合同协议表（支持电子签署、签名图片、签署时间等）
- `contract_templates` 合同模板表
- `service_periods` 服务期
- `service_segments` 分段
- `payments` 收费记录
- `users` 用户表

### 2. 主要业务逻辑

- **合同金额** = 服务期下所有分段的金额之和
- **周期性收费**：只允许录入至不超过合同金额，系统自动判断并禁止超额
- **催收提醒**：自动筛查所有未收全款的服务期
- **到期提醒**：只提醒未被续期的服务期，支持自定义天数
- **合同电子签署**：生成签署链接，支持客户在线签名，系统自动记录签署时间与签名图片

---

## 页面说明与操作建议

- 客户详情页展示周期性服务期（及分段）、临时收费记录
- 合同管理页可新建、编辑、签署、删除合同，可复制签署链接，客户可用手机/电脑完成电子签署
- 合同模板可自定义变量，签章/签名图片可自动插入
- 所有“新增收费”页面严格校验总收费金额不得超合同金额
- 支持多用户协作，建议根据实际场景设定合理的账号权限
- 首页右上方可一键导出全部业务数据为CSV表格

---

## 常见自定义扩展

- 可扩展套餐类型、分段备注等字段
- 如需导出数据，可用 SQLite 工具操作 `accounting.db`
- 如需更细致的权限管理，可自定义 `users` 表及相关校验逻辑
- 合同模板变量和合同编号等字段可按需添加和扩展

---

## 常见问题

- **Q：如何重置/备份数据？**  
  直接备份/替换 `accounting.db` 文件即可。

- **Q：支持多人协作吗？**  
  本地 SQLite 适合单用户/小团队，若并发需求高建议迁移至 MySQL 并适配 SQL 语句。

- **Q：如何添加其它字段或功能？**  
  修改相关表结构和页面即可，代码结构清晰，易于扩展。

- **Q：如何迁移至服务器部署？**  
  拷贝所有 PHP 文件和数据库文件至服务器，确保 PHP 环境和目录写权限，无需额外配置。

---

## 联系与支持

如有问题或定制需求，请联系开发者。欢迎提出建议和反馈，共同完善系统！